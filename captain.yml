portal-backend-build:
  build: ./src/docker/build/Dockerfile
  image: hbpmip/portal-backend-build
  pre:
    - echo "Building portal-backend-build"
  post:
    - docker run --rm -v $WORKSPACE:/opt/portal/ -v $HOME/.m2:/home/build/.m2/ hbpmip/portal-backend-build
    - echo "Finished building portal-backend-build"
  test:
    - ./tests/test-build.sh

portal-backend:
  build: ./src/docker/run/Dockerfile
  image: hbpmip/portal-backend
  pre:
    - echo "Building portal-backend"
    - mkdir -p $WORKSPACE/src/docker/run/config $WORKSPACE/src/docker/run/target
    - cp $WORKSPACE/config/application.tmpl $WORKSPACE/src/docker/run/config/
    - cp $WORKSPACE/target/*.jar $WORKSPACE/src/docker/run/target/
  post:
    - rm -rf $WORKSPACE/src/docker/run/target/
    - rm -rf $WORKSPACE/src/docker/run/config/
    - echo "Finished building portal-backend"
    - curl -k -X POST --data-urlencode payload@$WORKSPACE/src/docker/run/slack.json https://hbps1.chuv.ch/slack/dev-activity
  test:
    - ./tests/pre-test-run.sh
    - ./tests/test-run.sh
    - ./tests/post-test-run.sh
