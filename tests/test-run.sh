#!/usr/bin/env bash


# Define reference data

GROUPS_REF='{"code":"root","groups":[{"code":"tg1","label":"Test Group 1","groups":[{"code":"tg3","label":"Test Group 3","groups":[]}]},{"code":"tg2","label":"Test Group 2","groups":[{"code":"tg4","label":"Test Group 4","groups":[]}]}]}'

VARIABLES_REF='[{"code":"tv1","label":"Test Variable 1","type":"text","group":{"code":"tg3","label":"Test Group 3"},"isVariable":true},{"code":"tv2","label":"Test Variable 2","type":"integer","group":{"code":"tg4","label":"Test Group 4"},"isVariable":true},{"code":"tv3","label":"Test Variable 3","type":"real","group":{"code":"tg4","label":"Test Group 4"},"isVariable":true}]'

STATS_REF='{"users":1,"articles":0,"variables":3}'

VARIABLES_HIERARCHY_REF='{"code":"root","groups":[{"code":"tg1","label":"Test Group 1","groups":[{"code":"tg3","label":"Test Group 3","variables":[{"code":"tv1","label":"Test Variable 1","type":"text"}]}]},{"code":"tg2","label":"Test Group 2","groups":[{"code":"tg4","label":"Test Group 4","variables":[{"code":"tv2","label":"Test Variable 2","type":"integer"},{"code":"tv3","label":"Test Variable 3","type":"real"}]}]}]}'

REQUEST_BODY='{"variables":[{"code":"tv1"}],"groupings":[],"coVariables":[{"code":"tv2"},{"code":"tv3"}],"filters":[]}'
REQUEST_REF='{"code":"DS1474033923197","date":1.474033923197E12,"variable":["tv1"],"grouping":[],"header":["tv2","tv3"],"data":{"tv1":["val676                                                                                                                                                                                                                                                          ","val677                                                                                                                                                                                                                                                          ","val678                                                                                                                                                                                                                                                          ","val679                                                                                                                                                                                                                                                          ","val680                                                                                                                                                                                                                                                          ","val681                                                                                                                                                                                                                                                          ","val682                                                                                                                                                                                                                                                          ","val683                                                                                                                                                                                                                                                          ","val684                                                                                                                                                                                                                                                          ","val685                                                                                                                                                                                                                                                          ","val686                                                                                                                                                                                                                                                          ","val687                                                                                                                                                                                                                                                          ","val688                                                                                                                                                                                                                                                          ","val689                                                                                                                                                                                                                                                          ","val690                                                                                                                                                                                                                                                          ","val691                                                                                                                                                                                                                                                          ","val692                                                                                                                                                                                                                                                          ","val693                                                                                                                                                                                                                                                          ","val694                                                                                                                                                                                                                                                          ","val695                                                                                                                                                                                                                                                          ","val696                                                                                                                                                                                                                                                          ","val697                                                                                                                                                                                                                                                          ","val698                                                                                                                                                                                                                                                          ","val699                                                                                                                                                                                                                                                          ","val700                                                                                                                                                                                                                                                          ","val701                                                                                                                                                                                                                                                          ","val702                                                                                                                                                                                                                                                          ","val1081                                                                                                                                                                                                                                                         ","val1082                                                                                                                                                                                                                                                         ","val1083                                                                                                                                                                                                                                                         ","val1084                                                                                                                                                                                                                                                         ","val1085                                                                                                                                                                                                                                                         ","val1086                                                                                                                                                                                                                                                         ","val1087                                                                                                                                                                                                                                                         ","val1088                                                                                                                                                                                                                                                         ","val1089                                                                                                                                                                                                                                                         ","val1090                                                                                                                                                                                                                                                         ","val1091                                                                                                                                                                                                                                                         ","val1092                                                                                                                                                                                                                                                         ","val1093                                                                                                                                                                                                                                                         ","val1094                                                                                                                                                                                                                                                         ","val1095                                                                                                                                                                                                                                                         ","val1096                                                                                                                                                                                                                                                         ","val1097                                                                                                                                                                                                                                                         ","val1098                                                                                                                                                                                                                                                         ","val1099                                                                                                                                                                                                                                                         ","val1100                                                                                                                                                                                                                                                         ","val1101                                                                                                                                                                                                                                                         ","val1102                                                                                                                                                                                                                                                         ","val1103                                                                                                                                                                                                                                                         ","val1104                                                                                                                                                                                                                                                         ","val1105                                                                                                                                                                                                                                                         ","val1106                                                                                                                                                                                                                                                         ","val1107                                                                                                                                                                                                                                                         ","val1162                                                                                                                                                                                                                                                         ","val1163                                                                                                                                                                                                                                                         ","val1164                                                                                                                                                                                                                                                         ","val1165                                                                                                                                                                                                                                                         ","val1166                                                                                                                                                                                                                                                         ","val1167                                                                                                                                                                                                                                                         ","val1168                                                                                                                                                                                                                                                         ","val1169                                                                                                                                                                                                                                                         ","val1170                                                                                                                                                                                                                                                         ","val1171                                                                                                                                                                                                                                                         ","val1172                                                                                                                                                                                                                                                         ","val1173                                                                                                                                                                                                                                                         ","val1174                                                                                                                                                                                                                                                         ","val1175                                                                                                                                                                                                                                                         ","val1176                                                                                                                                                                                                                                                         ","val1177                                                                                                                                                                                                                                                         ","val1178                                                                                                                                                                                                                                                         ","val1179                                                                                                                                                                                                                                                         ","val1180                                                                                                                                                                                                                                                         ","val1181                                                                                                                                                                                                                                                         ","val1182                                                                                                                                                                                                                                                         ","val1183                                                                                                                                                                                                                                                         ","val1184                                                                                                                                                                                                                                                         ","val1185                                                                                                                                                                                                                                                         ","val1186                                                                                                                                                                                                                                                         ","val1187                                                                                                                                                                                                                                                         ","val1188                                                                                                                                                                                                                                                         ","val1189                                                                                                                                                                                                                                                         ","val1190                                                                                                                                                                                                                                                         ","val1191                                                                                                                                                                                                                                                         ","val1192                                                                                                                                                                                                                                                         ","val1193                                                                                                                                                                                                                                                         ","val1194                                                                                                                                                                                                                                                         ","val1195                                                                                                                                                                                                                                                         ","val1196                                                                                                                                                                                                                                                         ","val1197                                                                                                                                                                                                                                                         ","val1198                                                                                                                                                                                                                                                         ","val1199                                                                                                                                                                                                                                                         ","val1200                                                                                                                                                                                                                                                         ","val1201                                                                                                                                                                                                                                                         ","val1202                                                                                                                                                                                                                                                         ","val1203                                                                                                                                                                                                                                                         ","val1204                                                                                                                                                                                                                                                         ","val1205                                                                                                                                                                                                                                                         ","val1206                                                                                                                                                                                                                                                         ","val1207                                                                                                                                                                                                                                                         ","val1208                                                                                                                                                                                                                                                         ","val1209                                                                                                                                                                                                                                                         ","val1210                                                                                                                                                                                                                                                         ","val1211                                                                                                                                                                                                                                                         ","val1212                                                                                                                                                                                                                                                         ","val1213                                                                                                                                                                                                                                                         ","val1214                                                                                                                                                                                                                                                         ","val1215                                                                                                                                                                                                                                                         ","val1567                                                                                                                                                                                                                                                         ","val1568                                                                                                                                                                                                                                                         ","val1569                                                                                                                                                                                                                                                         ","val1570                                                                                                                                                                                                                                                         ","val1571                                                                                                                                                                                                                                                         ","val1572                                                                                                                                                                                                                                                         ","val1573                                                                                                                                                                                                                                                         ","val1574                                                                                                                                                                                                                                                         ","val1575                                                                                                                                                                                                                                                         ","val1576                                                                                                                                                                                                                                                         ","val1577                                                                                                                                                                                                                                                         ","val1578                                                                                                                                                                                                                                                         ","val1579                                                                                                                                                                                                                                                         ","val1580                                                                                                                                                                                                                                                         ","val1581                                                                                                                                                                                                                                                         ","val1582                                                                                                                                                                                                                                                         ","val1583                                                                                                                                                                                                                                                         ","val1584                                                                                                                                                                                                                                                         ","val1585                                                                                                                                                                                                                                                         ","val1586                                                                                                                                                                                                                                                         ","val1587                                                                                                                                                                                                                                                         ","val1588                                                                                                                                                                                                                                                         ","val1589                                                                                                                                                                                                                                                         ","val1590                                                                                                                                                                                                                                                         ","val1591                                                                                                                                                                                                                                                         ","val1592                                                                                                                                                                                                                                                         ","val1593                                                                                                                                                                                                                                                         ","val1702                                                                                                                                                                                                                                                         ","val1703                                                                                                                                                                                                                                                         ","val1704                                                                                                                                                                                                                                                         ","val1705                                                                                                                                                                                                                                                         ","val1706                                                                                                                                                                                                                                                         ","val1707                                                                                                                                                                                                                                                         ","val1708                                                                                                                                                                                                                                                         ","val1709                                                                                                                                                                                                                                                         ","val1710                                                                                                                                                                                                                                                         ","val1711                                                                                                                                                                                                                                                         ","val1712                                                                                                                                                                                                                                                         ","val1713                                                                                                                                                                                                                                                         ","val1714                                                                                                                                                                                                                                                         ","val1715                                                                                                                                                                                                                                                         ","val1716                                                                                                                                                                                                                                                         ","val1717                                                                                                                                                                                                                                                         ","val1718                                                                                                                                                                                                                                                         ","val1719                                                                                                                                                                                                                                                         ","val1720                                                                                                                                                                                                                                                         ","val1721                                                                                                                                                                                                                                                         ","val1722                                                                                                                                                                                                                                                         ","val1723                                                                                                                                                                                                                                                         ","val1724                                                                                                                                                                                                                                                         ","val1725                                                                                                                                                                                                                                                         ","val1726                                                                                                                                                                                                                                                         ","val1727                                                                                                                                                                                                                                                         ","val1728                                                                                                                                                                                                                                                         ","val1837                                                                                                                                                                                                                                                         ","val1838                                                                                                                                                                                                                                                         ","val1839                                                                                                                                                                                                                                                         ","val1840                                                                                                                                                                                                                                                         ","val1841                                                                                                                                                                                                                                                         ","val1842                                                                                                                                                                                                                                                         ","val1843                                                                                                                                                                                                                                                         ","val1844                                                                                                                                                                                                                                                         ","val1845                                                                                                                                                                                                                                                         ","val1846                                                                                                                                                                                                                                                         ","val1847                                                                                                                                                                                                                                                         ","val1848                                                                                                                                                                                                                                                         ","val1849                                                                                                                                                                                                                                                         ","val1850                                                                                                                                                                                                                                                         ","val1851                                                                                                                                                                                                                                                         ","val1852                                                                                                                                                                                                                                                         ","val1853                                                                                                                                                                                                                                                         ","val1854                                                                                                                                                                                                                                                         ","val1855                                                                                                                                                                                                                                                         ","val1856                                                                                                                                                                                                                                                         ","val1857                                                                                                                                                                                                                                                         ","val1858                                                                                                                                                                                                                                                         ","val1859                                                                                                                                                                                                                                                         ","val1860                                                                                                                                                                                                                                                         ","val1861                                                                                                                                                                                                                                                         ","val1862                                                                                                                                                                                                                                                         ","val1863                                                                                                                                                                                                                                                         "],"tv2":[676.0,677.0,678.0,679.0,680.0,681.0,682.0,683.0,684.0,685.0,686.0,687.0,688.0,689.0,690.0,691.0,692.0,693.0,694.0,695.0,696.0,697.0,698.0,699.0,700.0,701.0,702.0,1081.0,1082.0,1083.0,1084.0,1085.0,1086.0,1087.0,1088.0,1089.0,1090.0,1091.0,1092.0,1093.0,1094.0,1095.0,1096.0,1097.0,1098.0,1099.0,1100.0,1101.0,1102.0,1103.0,1104.0,1105.0,1106.0,1107.0,1162.0,1163.0,1164.0,1165.0,1166.0,1167.0,1168.0,1169.0,1170.0,1171.0,1172.0,1173.0,1174.0,1175.0,1176.0,1177.0,1178.0,1179.0,1180.0,1181.0,1182.0,1183.0,1184.0,1185.0,1186.0,1187.0,1188.0,1189.0,1190.0,1191.0,1192.0,1193.0,1194.0,1195.0,1196.0,1197.0,1198.0,1199.0,1200.0,1201.0,1202.0,1203.0,1204.0,1205.0,1206.0,1207.0,1208.0,1209.0,1210.0,1211.0,1212.0,1213.0,1214.0,1215.0,1567.0,1568.0,1569.0,1570.0,1571.0,1572.0,1573.0,1574.0,1575.0,1576.0,1577.0,1578.0,1579.0,1580.0,1581.0,1582.0,1583.0,1584.0,1585.0,1586.0,1587.0,1588.0,1589.0,1590.0,1591.0,1592.0,1593.0,1702.0,1703.0,1704.0,1705.0,1706.0,1707.0,1708.0,1709.0,1710.0,1711.0,1712.0,1713.0,1714.0,1715.0,1716.0,1717.0,1718.0,1719.0,1720.0,1721.0,1722.0,1723.0,1724.0,1725.0,1726.0,1727.0,1728.0,1837.0,1838.0,1839.0,1840.0,1841.0,1842.0,1843.0,1844.0,1845.0,1846.0,1847.0,1848.0,1849.0,1850.0,1851.0,1852.0,1853.0,1854.0,1855.0,1856.0,1857.0,1858.0,1859.0,1860.0,1861.0,1862.0,1863.0],"tv3":[67.6,67.7,67.8,67.9,68.0,68.1,68.2,68.3,68.4,68.5,68.6,68.7,68.8,68.9,69.0,69.1,69.2,69.3,69.4,69.5,69.6,69.7,69.8,69.9,70.0,70.1,70.2,108.1,108.2,108.3,108.4,108.5,108.6,108.7,108.8,108.9,109.0,109.1,109.2,109.3,109.4,109.5,109.6,109.7,109.8,109.9,110.0,110.1,110.2,110.3,110.4,110.5,110.6,110.7,116.2,116.3,116.4,116.5,116.6,116.7,116.8,116.9,117.0,117.1,117.2,117.3,117.4,117.5,117.6,117.7,117.8,117.9,118.0,118.1,118.2,118.3,118.4,118.5,118.6,118.7,118.8,118.9,119.0,119.1,119.2,119.3,119.4,119.5,119.6,119.7,119.8,119.9,120.0,120.1,120.2,120.3,120.4,120.5,120.6,120.7,120.8,120.9,121.0,121.1,121.2,121.3,121.4,121.5,156.7,156.8,156.9,157.0,157.1,157.2,157.3,157.4,157.5,157.6,157.7,157.8,157.9,158.0,158.1,158.2,158.3,158.4,158.5,158.6,158.7,158.8,158.9,159.0,159.1,159.2,159.3,170.2,170.3,170.4,170.5,170.6,170.7,170.8,170.9,171.0,171.1,171.2,171.3,171.4,171.5,171.6,171.7,171.8,171.9,172.0,172.1,172.2,172.3,172.4,172.5,172.6,172.7,172.8,183.7,183.8,183.9,184.0,184.1,184.2,184.3,184.4,184.5,184.6,184.7,184.8,184.9,185.0,185.1,185.2,185.3,185.4,185.5,185.6,185.7,185.8,185.9,186.0,186.1,186.2,186.3]}}'

ARTICLE_BODY='{"status":"closed","content":"<!DOCTYPE html>\n<html>\n<head>\n</head>\n<body>\n<p>test<br data-mce-bogus=\"1\"></p>\n</body>\n</html>","title":"Test","abstract":"test","date":"2016-09-16T10:57:02.206Z"}'
ARTICLE_REF='[{"slug":"test","title":"Test","status":"closed","content":"<!DOCTYPE html>\n<html>\n<head>\n</head>\n<body>\n<p>test<br data-mce-bogus=\"1\"></p>\n</body>\n</html>","createdAt":1474035349482,"createdBy":{"username":"Anonymous","fullname":"Anonymous","languages":[],"roles":[],"agreeNDA":true,"votedApps":[]},"tags":[],"abstract":"test"}]'


# Get gateway IP

GATEWAY_IP=$(docker inspect backend-test | grep \"Gateway\":\ \" | sed 's/.*Gateway\":\ \"\([^-]*\)\",/\1/' | head -n 1)


# Test - GET groups

if [ "$(curl -s ${GATEWAY_IP}:65434/services/groups)" != "$GROUPS_REF" ]; then
  echo "Tests failed - failed to load groups"
  exit 1
fi


# Test - GET variables

if [ "$(curl -s ${GATEWAY_IP}:65434/services/variables)" != "$VARIABLES_REF" ]; then
  echo "Tests failed - failed to load variables"
  exit 1
fi


# Test - GET stats

if [ "$(curl -s ${GATEWAY_IP}:65434/services/stats)" != "$STATS_REF" ]; then
  echo "Tests failed - failed to load stats"
  exit 1
fi


# Test - GET variables hierarchy

if [ "$(curl -s ${GATEWAY_IP}:65434/services/variables/hierarchy)" != "$VARIABLES_HIERARCHY_REF" ]; then
  echo "Tests failed - failed to load variables hierarchy"
  exit 1
fi


# Test - POST requests

response=$(curl -s -H "Content-Type: application/json" -X POST -d ${REQUEST_BODY} ${GATEWAY_IP}:65434/services/queries/requests)
if [ "${response:52}" != "${REQUEST_REF:52}" ]; then
  echo "Tests failed - failed to post requests"
  exit 1
fi


echo "Tests successfully passed"

exit 0
